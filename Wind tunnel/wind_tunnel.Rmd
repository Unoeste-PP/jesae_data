---
title: "wind_tunnel" 
author: "Maxwel Coura Oliveira"
date: "2/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
library(tidymodels)
library(tidytext)
```


```{r}
data <- read.csv("windtunnel_data.csv") %>% 
  janitor::clean_names() %>% 
  mutate_if(is_character, as_factor) %>% 
  mutate(orifice_size = as_factor(orifice_size))
```

```{r}
data %>% 
  ggplot(aes(x = pressure, dv50)) + 
  geom_jitter(alpha = 0.1, width = 6) +
  geom_smooth(method = "lm") +
  facet_wrap(solution_name ~ nozzle)
```


```{r}
data %>% 
  group_by(nozzle) %>% 
  nest()
```



```{r linear-model}
lm_mod <- 
  linear_reg() %>% 
  set_engine("lm")
```


```{r}
lm_fit <- 
  lm_mod %>% 
  fit(fines_200 ~ solution_name * nozzle * orifice_size * pressure, data = data)
```


```{r}
tidy(lm_fit)
```

```{r}
new_points <- expand.grid(pressure = 40, 
                          solution_name = c("water", 
                                       "dicamba", 
                                       "glyphosate", 
                                       "dicamba+glyphosate",
                                       "dicamba+glyphosate+dra2",
                            "dicamba+glyphosate+clethodim+acetochlor+dra2",
                            "dicamba+glyphosate+clethodim+dra2", 
                            "dicamba+glyphosate+clethodim+dra2",
                        "dicamba+glyphosate+clethodim+s-metolachlor+dra2",
                        "dicamba+glyphosate+dra1",
                        "dicamba+glyphosate+clethodim+dra1"), 
                        orifice_size = c("0.3", "0.4", "0.5", "0.6"),
                        nozzle = c("AI80", "AI110", "TADFD", "TDXLD",
                                   "ULD", "TTI", "TADF"))
new_points
```

```{r}
#Getting predited values
mean_pred <- predict(lm_fit, new_data = new_points)
mean_pred
```



```{r}
#Getting conf intervals
conf_int_pred <- predict(lm_fit, 
                         new_data = new_points, 
                         type = "conf_int")
conf_int_pred
```


```{r}
# Plotting biomass (% untreated) at GDD = 1000 (your choice)
data1 <- 
  new_points %>% 
  bind_cols(mean_pred) %>% 
  bind_cols(conf_int_pred)
```



```{r}
data1 %>% 
  filter(orifice_size == "0.4") %>% 
  mutate(is_water = if_else(solution_name == "water", TRUE, FALSE)) %>% 
  mutate(solution_name = reorder_within(solution_name, 
                                 by = .pred, 
                                 within = nozzle)) %>% 
  ggplot(aes(x = solution_name, y = .pred, color = is_water)) +
  geom_point() +
  scale_x_reordered() +
  scale_y_continuous(limits = c(0, 5)) +
  geom_errorbar(aes(ymin = .pred_lower, 
                    ymax = .pred_upper),
                width = .2) +
  scale_color_manual(values = c("black", "red")) +
  facet_wrap(~ nozzle, scales = "free") + 
  coord_flip() +
  theme_bw() +
  labs(y = "", x = "",
    title = "Percent of drifable fines (< 200) at 40 psi and orifice size = 0.4") +
  theme(legend.position = "none",
        plot.title = element_text(size = 20)) +
  ggsave("figure.png", width = 16, height = 8)
```

